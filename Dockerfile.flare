# SPDX-License-Identifier: GPL-2.0
ARG BASE_IMAGE
FROM $BASE_IMAGE as builder

RUN DEBIAN_FRONTEND=noninteractive apt -y install git

WORKDIR /src
RUN git clone https://github.com/hihg-um/flare.git  && \
	javac -cp flare/src/ flare/src/admix/AdmixMain.java && \
	jar cfe flare.jar admix/AdmixMain -C flare/src/ ./ && \
	jar -i flare.jar

FROM $BASE_IMAGE

ARG RUN_CMD
ENV RUN_CMD=${RUN_CMD}

ENV JAR_PATH=/opt/java/bin
COPY --from=builder --chmod0444 /src/flare.jar $JAR_PATH/flare.jar

ARG TEST="/test.sh"
COPY src/test/$RUN_CMD.sh ${TEST}
RUN chmod ugo+rx ${TEST}

ARG ARG ENTRY="/entrypoint.sh"
RUN echo "#!/bin/bash\n$RUN_CMD \$@" > ${ENTRY} && chmod ugo+rx ${ENTRY}
ENTRYPOINT [ "/entrypoint.sh" ]
